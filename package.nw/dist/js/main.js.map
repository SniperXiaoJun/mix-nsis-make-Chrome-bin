{"version":3,"sources":["NPBank.js","app.js","network.js","securePage.js","homePage.js","certPage.js","devicePage.js","downloadPage.js","main.js"],"names":[],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACtcA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC3HA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACxDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC/zBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACzDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACrHA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC5EA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AChSA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"main.js","sourcesContent":["/**\r\n *\r\n * Created by Jonathan on 2016-12-9.\r\n */\r\n\r\n\"use strict\";\r\n\r\n/**\r\n * NPBank.dll 的封装类\r\n * @param id\r\n * @constructor\r\n */\r\nfunction NPBank(id) {\r\n  this.id = id;\r\n\r\n  var embed = document.createElement(\"embed\");\r\n  embed.setAttribute('type', 'application/x-wtbank');\r\n  embed.setAttribute('id', id);\r\n  document.body.appendChild(embed);\r\n\r\n  var me = this;\r\n  var keyInjectListeners = [],\r\n      keyEjectListeners = [];\r\n\r\n  embed.onUKeyOn = function (resp) {\r\n    console.log('NPBank onUkeyOn', resp);\r\n    for (var i = 0; i < keyInjectListeners.length; i++) {\r\n      keyInjectListeners[i].call(me);\r\n    }\r\n  };\r\n\r\n  embed.onUKeyOff = function (resp) {\r\n    console.log('NPBank onUKeyOff', resp);\r\n    for (var i = 0; i < keyEjectListeners.length; i++) {\r\n      keyEjectListeners[i].call(me);\r\n    }\r\n  };\r\n\r\n  // 激活事件监测\r\n  embed.addListenerSync();\r\n\r\n  this.plugin = embed;\r\n  this.keyInjectListeners = keyInjectListeners;\r\n  this.keyEjectListeners = keyEjectListeners;\r\n  this.deviceCertData = [];\r\n}\r\n\r\n//-----------------------------------------------------------\r\n//----- 常量\r\n//-----------------------------------------------------------\r\n\r\n/**\r\n * 程序类型\r\n * @type {{DRIVER: number, PLUGIN: number}}\r\n */\r\nNPBank.PROGRAM_TYPE = {\r\n  DRIVER: 1,\r\n  PLUGIN: 2\r\n};\r\n\r\n\r\n/**\r\n * 证书类型\r\n * @type {{RSA: number, SM2: number}}\r\n */\r\nNPBank.CERT_TYPE = {\r\n  RSA: 1,\r\n  SM2: 2\r\n};\r\n\r\n\r\n/**\r\n * 事件类型\r\n * @type {{INJECT: number, EJECT: number}}\r\n */\r\nNPBank.EVENT_TYPE = {\r\n  INJECT: 1,\r\n  EJECT: 2\r\n};\r\n\r\n\r\n//-----------------------------------------------------------\r\n//-- 方法: 绑定事件\r\n//-----------------------------------------------------------\r\n\r\n/**\r\n * 添加事件监听\r\n * @param event\r\n * @param handler\r\n */\r\nNPBank.prototype.addListener = function (event, handler) {\r\n  if (event == NPBank.EVENT_TYPE.INJECT) {\r\n    this.keyInjectListeners.push(handler);\r\n  }\r\n  else if (event == NPBank.EVENT_TYPE.EJECT) {\r\n    this.keyEjectListeners.push(handler);\r\n  }\r\n};\r\n\r\n\r\n/**\r\n * 清除事件监听\r\n * @param event\r\n * @param handler\r\n */\r\nNPBank.prototype.removeListener = function (event, handler) {\r\n  var listeners = event == 'keyInject' ? this.keyInjectListeners : this.keyEjectListeners;\r\n  for (var i = 0; i < listeners.length; i++) {\r\n    if (listeners[i] === handler) {\r\n      listeners.slice(i, 1);\r\n    }\r\n  }\r\n};\r\n\r\n\r\n//-----------------------------------------------------------\r\n//----- 方法：设备与证书\r\n//-----------------------------------------------------------\r\n\r\n/**\r\n * 读取设备和证书信息\r\n * WTF: 超级恶心的数据结构！\r\n *\r\n * @param callback\r\n *\r\n * 如果是 CSP 的设备，属性是这样的：\r\n *\r\n * [{\r\n *   \"name\": \"0305339200000807\",\r\n *   \"devFrom\" : \"csp\",\r\n *   \"devNickName\" : \"9556809002340024\",\r\n *   \"serialNumber\" : \"unknow\"\r\n *   \"certs\": [{},...]\r\n * },...]\r\n *\r\n *\r\n * 如果是 SKF 的设备，属性是这样的：\r\n *\r\n * [{\r\n *   \"devAuthAlgId\" : 16842752,\r\n *   \"devFrom\" : \"skf\",\r\n *   \"devNickName\" : \"0305549100001236\",\r\n *   \"firmwareVersion.major\" : 49,\r\n *   \"firmwareVersion.minor\" : 48,\r\n *   \"freeSpace\" : 2424832,\r\n *   \"hwVersion.major\" : 49,\r\n *   \"hwVersion.minor\" : 48,\r\n *   \"issuer\" : \"CMBC\",\r\n *   \"label\" : \"CMBC\",\r\n *   \"manufacturer\" : \"HB\",\r\n *   \"serialNumber\" : \"5330000238036648\",\r\n *   \"totalSpace\" : 3604480,\r\n *   \"version.major\" : 49,\r\n *   \"version.minor\" : 48\r\n *   \"certs\": [{},...]\r\n * },...]\r\n *\r\n *\r\n * 注意哦，属性名不只大小写无规则，而且是\r\n *    动态变的！\r\n *    动态变的！\r\n *    动态变的！\r\n * 根据 “devFrom” 不同而不同，这是数组吗？！\r\n *\r\n *\r\n * certs 数据中证书的结构为：\r\n *  {\r\n *    \"certContentB64String\" : \"\",\r\n *    \"commonName\" : \"9556809002340024\",\r\n *    \"issuer\" : \"O=CFCA TEST CA\",\r\n *    \"notAfter\" : \"2017-06-13 10:51:42\",\r\n *    \"notBefore\" : \"2017-03-13 10:51:42\",\r\n *    \"serialNumber\" : \"78 34 4D 2D 02 D6 BF 5C A3 D7 F2 47 5E D8 1A 39 \",\r\n *    \"signType\" : 1,\r\n *    \"subject\" : \"CN=9556809002340024\",\r\n *    \"type\" : 1,\r\n *    \"verify\" : 2\r\n *  }\r\n *\r\n *  所以，当你判断用户用的是什么设备时，\r\n *\r\n *  如果是 NULL, 就认为没插入设备; (JSON结构还能返回null？)\r\n *  如果全是 CSP 设备，就认为是 CSP 设备;\r\n *  如果全是 SKF 设备，就认为是 SFK 设备;\r\n *  如果既有 SKF 又有 CSP 设备，那你就自己决定吧！！！\r\n *\r\n */\r\nNPBank.prototype.readDeviceAndCert = function (callback) {\r\n  console.log('NPBank readDeviceAndCert');\r\n  var me = this;\r\n  this.plugin.readUkeyCertInfo(function (resp) {\r\n    me.deviceCertData = JSON.parse(resp);\r\n    callback.call(me, me.deviceCertData);\r\n  });\r\n};\r\n\r\n\r\n\r\nNPBank.prototype.readDevice = function (callback) {\r\n  console.log('NPBank readDevice');\r\n  var me = this;\r\n  this.plugin.readUkeyInfo(function (resp) {\r\n    callback.call(me, JSON.parse(resp));\r\n  });\r\n};\r\n\r\n\r\n/**\r\n * 验证设备密码\r\n * @param b64DeviceData\r\n * @param password\r\n * @param callback\r\n */\r\nNPBank.prototype.verifyDevicePassword = function (b64DeviceData, password, callback) {\r\n  this.plugin.verifyDevPassword(b64DeviceData, password, callback);\r\n};\r\n\r\n\r\n/**\r\n * 修改证书\r\n * @param b64DeviceData\r\n * @param oldPassword\r\n * @param password\r\n * @param callback\r\n */\r\nNPBank.prototype.changeDevicePassword = function (b64DeviceData, oldPassword, password, callback) {\r\n  this.plugin.changeUkeyPassword(b64DeviceData, oldPassword, password, function (resp) {\r\n    callback.call(this, JSON.parse(resp));\r\n  });\r\n};\r\n\r\n\r\n/**\r\n * 弹出证书显示窗口\r\n * @param cert\r\n */\r\nNPBank.prototype.showCert = function (cert) {\r\n  if (!cert['certContentB64String']) {\r\n    return;\r\n  }\r\n  this.plugin.showCert(cert['certContentB64String']);\r\n};\r\n\r\n\r\n/**\r\n * 安装证书\r\n * @param certFiles\r\n * @param certType\r\n * @param callback\r\n */\r\nNPBank.prototype.installCACert = function (certFiles, certType, callback) {\r\n  certFiles = $.isArray(certFiles) ? certFiles : [certFiles];\r\n  var me = this;\r\n  if (certType == NPBank.CERT_TYPE.RSA) {\r\n    this.plugin.installCaCertRSA(certFiles.join(','), function (resp) {\r\n      callback.call(me, JSON.parse(resp));\r\n    });\r\n  }\r\n  else if (certType == NPBank.CERT_TYPE.SM2) {\r\n    this.plugin.installCaCertSM2(certFiles.join(','), function (resp) {\r\n      callback.call(me, JSON.parse(resp));\r\n    });\r\n  }\r\n};\r\n\r\n\r\n/**\r\n * 通过属性/值查询证书\r\n * @param property\r\n * @param value\r\n * @param callback\r\n */\r\nNPBank.prototype.getCert = function (property, value, callback) {\r\n  var me = this;\r\n\r\n  function foundCert(deviceCertData, callback) {\r\n    var cert = false;\r\n    for (var i = 0, deviceCount = deviceCertData.length; i < deviceCount; i++) {\r\n      var certs = deviceCertData[i]['certs'];\r\n\r\n      for (var j = 0, certCount = certs.length; j < certCount; j++) {\r\n        // found it\r\n        if (certs[j][property] == value) {\r\n          cert = certs[j];\r\n          break;\r\n        }\r\n      }\r\n      if (cert) break;\r\n    }\r\n    callback.call(me, cert);\r\n  }\r\n\r\n  if (this.deviceCertData.length > 0) {\r\n    foundCert(me.deviceCertData, callback);\r\n  }\r\n  else {\r\n    me.readDeviceAndCert(function (deviceCertData) {\r\n      foundCert(deviceCertData, callback);\r\n    })\r\n  }\r\n};\r\n\r\n\r\n//-----------------------------------------------------------\r\n//----- 安全检测\r\n//-----------------------------------------------------------\r\n\r\n\r\n/**\r\n * 列出本地文件的版本\r\n * @param filePath\r\n * @param callback\r\n */\r\nNPBank.prototype.checkVersion = function (filePath, callback) {\r\n  this.plugin.getLocalFileVersion(filePath, callback);\r\n};\r\n\r\n\r\n/**\r\n * 检查系统信息\r\n * @returns {*}\r\n */\r\nNPBank.prototype.checkSystemInfo = function () {\r\n  return JSON.parse(this.plugin.detectSystem());\r\n};\r\n\r\n\r\n/**\r\n * 检查杀毒软件\r\n * @returns {*}\r\n */\r\nNPBank.prototype.checkAntivirus = function () {\r\n  return JSON.parse(this.plugin.detectAntivirus());\r\n};\r\n\r\n\r\n/**\r\n * 检查防火墙\r\n * @returns {*}\r\n */\r\nNPBank.prototype.checkFirewall = function () {\r\n  return JSON.parse(this.plugin.detectFireWall());\r\n};\r\n\r\n\r\nNPBank.prototype.checkTime = function (callback) {\r\n  var me = this;\r\n  this.plugin.detectTime(function (resp) {\r\n    callback.call(me, JSON.parse(resp));\r\n  });\r\n};\r\n\r\n\r\n/**\r\n * 检查 HOST 文件\r\n * @param callback\r\n */\r\nNPBank.prototype.checkHost = function (host, callback) {\r\n  var me = this;\r\n  this.plugin.detectHost(host, function (resp) {\r\n    callback.call(me, JSON.parse(resp));\r\n  });\r\n};\r\n\r\n/**\r\n * 检查银行网站是否可连通\r\n * @param callback\r\n */\r\nNPBank.prototype.checkBankWebsite = function (host, subsite, port, callback) {\r\n  var me = this;\r\n  this.plugin.detectBankWebsite(host, subsite, port, function (resp) {\r\n    callback.call(me, JSON.parse(resp));\r\n  });\r\n};\r\n\r\n\r\n/**\r\n * 检查证书链\r\n * @param certs\r\n * @param certType\r\n * @param callback\r\n */\r\nNPBank.prototype.checkCertChain = function (certs, certType, callback) {\r\n  var me = this;\r\n  certs = $.isArray(certs) ? certs : [certs];\r\n\r\n  this.plugin.checkCertChain(certs.join(','), certType, function (resp) {\r\n    callback.call(me, JSON.parse(resp));\r\n  });\r\n};\r\n\r\n\r\n/**\r\n * 列出 SKF 驱动\r\n * @param name\r\n * @param callback\r\n */\r\nNPBank.prototype.checkSKFDriver = function (name, callback) {\r\n  var me = this;\r\n  this.plugin.listSKFDriver(name, function (resp) {\r\n    callback.call(me, JSON.parse(resp));\r\n  });\r\n};\r\n\r\n\r\n/**\r\n * 列出系统控件\r\n * @param name\r\n * @param callback\r\n */\r\nNPBank.prototype.checkSystemControl = function (name, callback) {\r\n  this.plugin.listSystemControl(name, callback);\r\n};\r\n\r\n\r\n/**\r\n * 检查插件\r\n * @param name\r\n * @returns {boolean}\r\n */\r\nNPBank.prototype.checkPlugin = function (name) {\r\n  for (var i = 0; i < navigator.plugins.length; i++) {\r\n    if (navigator.plugins[i].name.indexOf(name) != -1) {\r\n      return true;\r\n    }\r\n  }\r\n  return false;\r\n};\r\n\r\n/**\r\n * 安装程序或补丁\r\n * @param programPath\r\n * @param cmdArgs\r\n * @param programType\r\n * @param callback\r\n */\r\nNPBank.prototype.installApplication = function (programPath, cmdArgs, programType, callback) {\r\n  var me = this;\r\n  this.plugin.installApp(programPath, cmdArgs, programType, function (resp) {\r\n    callback.call(me, JSON.parse(resp));\r\n  });\r\n};\r\n\r\n\r\n/**\r\n * 修复 HOST 文件\r\n * @param domain\r\n * @param callback\r\n */\r\nNPBank.prototype.repairHostFile = function (domain, callback) {\r\n  var me = this;\r\n  this.plugin.repairHostFile(domain, function (resp) {\r\n    callback.call(me, JSON.parse(resp));\r\n  });\r\n};","/**\r\n * Created by Jonathan on 2016-12-11.\r\n */\r\nvar app = new function() {\r\n  var me = this;\r\n  this.observers = [];\r\n\r\n  this.LOGIN_URL = 'https://ent.cmbc.com.cn/eweb/static/login.html';\r\n  this.CSP_LOGIN_URL = 'https://111.205.207.146/eweb/static/loginKey.html';\r\n  this.SKF_LOGIN_URL = 'https://111.205.207.146/eweb/static/loginKey.html';\r\n  this.NO_KEY_URL = 'http://www.cmbc.com.cn/netbankmsg/clientnocert.html';\r\n\r\n  this.register = function (observer){\r\n    me.observers.push(observer);\r\n  };\r\n\r\n  this.unregister = function (observer) {\r\n    for(var i=0; i<me.observers.length; i++){\r\n      if (observer === me.observers[i]){\r\n        me.observers.slice(i,1);\r\n        break;\r\n      }\r\n    }\r\n  };\r\n\r\n  this.notify = function (eventName, data) {\r\n    var event = {\r\n      name: eventName,\r\n      data: data\r\n    };\r\n\r\n    for(var i=0; i<me.observers.length; i++){\r\n      var observer = me.observers[i];\r\n      if (observer['update']){\r\n        observer.update(event);\r\n      }\r\n    }\r\n  };\r\n\r\n  function clearCache(){\r\n    chrome.browsingData.remove({\r\n      \"since\": 0  //remove all browsing data\r\n    }, {\r\n      \"appcache\": true,\r\n      \"cache\": true,\r\n      \"cookies\": true,\r\n      \"downloads\": true,\r\n      \"fileSystems\": true,\r\n      \"formData\": true,\r\n      \"history\": true,\r\n      \"indexedDB\": true,\r\n      \"localStorage\": true,\r\n      \"pluginData\": true,\r\n      \"passwords\": true,\r\n      \"webSQL\": true\r\n    }, function () {\r\n    });\r\n  }\r\n  \r\n  function onKeyEject() {\r\n    console.log('app eject', arguments);\r\n    me.notify('keyEject');\r\n\r\n    clearCache();\r\n\r\n    $.confirm({\r\n      text: \"U宝已弹出，为保证安全，请您关闭客户端！\",\r\n      confirmButton: \"关闭客户端\",\r\n      cancelButton: false,\r\n      confirm: function(button) {\r\n        win.close();\r\n      }\r\n    });\r\n  }\r\n\r\n  function onKeyInject() {\r\n    console.log('app inject', arguments);\r\n    me.notify('keyInject');\r\n    readUkey();\r\n  }\r\n\r\n  function readUkey() {\r\n    me.keyPlugin.readDeviceAndCert(function (deviceCertData) {\r\n      console.log('app readUkey', arguments);\r\n      me.notify('deviceCertUpdate', deviceCertData);\r\n    })\r\n  }\r\n\r\n\r\n  var loadingTimeout = null;\r\n\r\n  this.freezeScreen = function (msg, callback) {\r\n    $.isLoading({text: msg});\r\n\r\n    loadingTimeout = setTimeout(function () {\r\n      $.isLoading(\"hide\");\r\n      if (callback)\r\n        callback.call();\r\n    }, 60000);\r\n  };\r\n\r\n\r\n  this.releaseScreen = function releaseScreen() {\r\n    clearTimeout(loadingTimeout);\r\n    $.isLoading(\"hide\");\r\n  };\r\n  \r\n  this.init = function () {\r\n    me.keyPlugin = new NPBank('key-plugin');\r\n\r\n    me.keyPlugin.addListener(NPBank.EVENT_TYPE.INJECT, onKeyInject);\r\n\r\n    me.keyPlugin.addListener(NPBank.EVENT_TYPE.EJECT, onKeyEject);\r\n\r\n    win.on('close', function(event) {\r\n      clearCache();\r\n      win.close(true);\r\n    });\r\n\r\n    // 初始化先读一次UKey\r\n    readUkey();\r\n  }\r\n};\r\n","var Network = function () {\r\n\r\n  function clearCache() {\r\n    chrome.browsingData.remove({\r\n      \"since\": 0  //remove all browsing data\r\n    }, {\r\n      \"appcache\": true,\r\n      \"cache\": true,\r\n      \"cookies\": true,\r\n      \"downloads\": true,\r\n      \"fileSystems\": true,\r\n      \"formData\": true,\r\n      \"history\": true,\r\n      \"indexedDB\": true,\r\n      \"localStorage\": true,\r\n      \"pluginData\": true,\r\n      \"passwords\": true,\r\n      \"webSQL\": true\r\n    }, function () {\r\n      toastr.success('缓存清除成功！');\r\n    });\r\n  }\r\n\r\n  function setProxy(host, port, name, password) {\r\n    var config = {\r\n      mode: \"fixed_servers\",\r\n      rules: {\r\n        singleProxy: {\r\n          scheme: \"http\",\r\n          host: host,\r\n          port: port\r\n        },\r\n        bypassList: []\r\n      }\r\n    };\r\n\r\n    chrome.proxy.settings.set({\r\n      value: config,\r\n      scope: 'regular'\r\n    }, function () {\r\n    });\r\n  }\r\n\r\n\r\n  function setExitClear(clearCacheAfterExit) {\r\n    localStorage.clearCacheAfterExit = this.checked;\r\n  }\r\n\r\n  // 暴露接口\r\n  return {\r\n    setExitClear: setExitClear,\r\n    clearCache: clearCache,\r\n    setProxy: setProxy\r\n  }\r\n\r\n}();\r\n","/**\r\n * 目前屏蔽了每个危险项的修改，只提供一键全部修复\r\n *\r\n * @type {securePage}\r\n * \r\n * 1.RSA检测1（测试）\r\n * 4672dc25729f024e5583b580f90bdbe993b3f445\r\n * 修复：\r\n * cfca_test_ca.cer\r\n * cfca_test_gt_rca.cer\r\n *\r\n * 2.RSA检测2（测试）\r\n * cfdf99fb86221613392c075e8e3d772bb969ef8e\r\n * cfca_rsa_1.cer\r\n * cfca_rsa_2.cer\r\n *\r\n * 3.RSA检测3（正式）\r\n * d1dbe98882e5dd1a8f4caa008cbe7cf2ab1bf6d9\r\n * CFCA_RSA_NORMAL_1.cer\r\n * CFCA_RSA_NORMAL_2.cer\r\n *\r\n * 4.SM2检测1(测试)\r\n * e27eb610bb94eb15e6aed1150affe8d7a057399d\r\n * cfca_sm2_1.cer\r\n * cfca_sm2_2.cer\r\n *\r\n * 5.SM2检测2(正式)\r\n * 5c9358205a247356101b645010ece9a7ca074111\r\n * CFCA_SM2_NORMAL_0.cer\r\n * CFCA_SM2_NORMAL_1.cer\r\n * CFCA_SM2_NORMAL_2.cer\r\n *\r\n */\r\n\r\n\"use strict\";\r\n\r\nvar securePage = new function () {\r\n\r\n  /**\r\n   * 检查的项目列表\r\n   *\r\n   * @type {{SYSTEM: number, TIME: number, ANTIVIRUS: number, FIREWALL: number, TRUST_SITE: number, UNTRUST_SITE: number, WEBSITE: number, HOST: number, SYSTEM_PATCH: number, SM2_CERT: number, RSA_CERT: number, UKEY_DRIVER: number, PLUGIN: number}}\r\n   */\r\n  var kDetectID = {\r\n    'SYSTEM': 0,\r\n    'TIME': 1,\r\n    'ANTIVIRUS': 2,\r\n    'FIREWALL': 3,\r\n    'TRUST_SITE': 4,\r\n    'UNTRUST_SITE': 5,\r\n    'WEBSITE': 6,\r\n    'HOST': 7,\r\n    'SYSTEM_PATCH': 8,\r\n    'SM2_CERT': 9,\r\n    'RSA_CERT': 10,\r\n    'UKEY_DRIVER': 11,\r\n    'PLUGIN': 12\r\n  };\r\n\r\n\r\n  var startButton = $('#start-btn'),\r\n      cancelButton = $('#cancel-btn'),\r\n      fixAllButton = $('#fix-all-btn'),\r\n      restartButton = $('#restart-btn'),\r\n      infoEl = $('.top-title p'),\r\n      sliderEl = $('.slider .thumb'),\r\n      titleEl = $('.top-title h3'),\r\n      dangerCountEl = $('.danger-title .itemCount'),\r\n      warningCountEl = $('.warning-title .itemCount'),\r\n      safeCountEl = $('.safe-title .itemCount'),\r\n      dangerCtEl = $('.danger-list'),\r\n      warningCtEl = $('.warning-list'),\r\n      safeCtEl = $('.safe-list');\r\n\r\n\r\n  /**\r\n   * 检查数量统计\r\n   */\r\n  var me = this,\r\n      plugin = null,\r\n      isRunning = false,  // 是否正在执行扫描\r\n      dangerCount = [],\r\n      warningCount = [],\r\n      safeCount = [],\r\n      fixedCount = 0,\r\n      fixedFinished = 0,\r\n      resultQueue = [],\r\n      resultIndex = 0,\r\n      resultTimer = null,\r\n      needRestartBrowser = false,\r\n      listNameLength = 64;\r\n\r\n  const path = require('path');\r\n\r\n\r\n\r\n  //-----------------------------------------------------------\r\n  //-- 安全检测\r\n  //-----------------------------------------------------------\r\n\r\n  function detectSystemInfo() {\r\n    var sysInfo = plugin.checkSystemInfo();\r\n    var task = enqueueTask('操作系统', function () {\r\n      if (sysInfo['success']) {\r\n        addSafeResult(kDetectID.SYSTEM, '系统：' + sysInfo['sysinfo'])\r\n      } else {\r\n        addWarningResult(kDetectID.SYSTEM, '检测系统失败');\r\n      }\r\n    });\r\n    task.finished = true;\r\n  }\r\n\r\n\r\n  function detectAntivirus() {\r\n    var antiVirus = plugin.checkAntivirus();\r\n    var task = enqueueTask('杀毒软件', function () {\r\n      if (antiVirus['success']) {\r\n        addSafeResult(kDetectID.ANTIVIRUS, '已经安装杀毒软件：' + antiVirus['product_name']);\r\n      } else {\r\n        addDangerResult(kDetectID.ANTIVIRUS, '没有检测到杀毒软件');\r\n      }\r\n    });\r\n    task.finished = true;\r\n  }\r\n\r\n\r\n  function detectFirewall() {\r\n    var fireWall = plugin.checkFirewall();\r\n    var task = enqueueTask('防火墙', function () {\r\n      if (fireWall['success']) {\r\n        addSafeResult(kDetectID.FIREWALL, '防火墙设置正常');\r\n      } else {\r\n        addDangerResult(kDetectID.FIREWALL, '防火墙设置异常');\r\n      }\r\n    });\r\n    task.finished = true;\r\n  }\r\n\r\n\r\n  function detectHost(host) {\r\n    var task = enqueueTask('检查系统HOST文件', false);\r\n    plugin.checkHost(host, function (result) {\r\n      task.result = function () {\r\n        if (!result['success']) {\r\n          addSafeResult(kDetectID.HOST, 'HOST 文件正常');\r\n        } else {\r\n          addDangerResult(kDetectID.HOST, 'HOST 文件存在劫持风险');\r\n        }\r\n      };\r\n      task.finished = true;\r\n    });\r\n  }\r\n\r\n\r\n  function detectRSACertChain(certs) {\r\n    var task = enqueueTask('检测 RSA 证书链', false);\r\n    plugin.checkCertChain(certs, NPBank.CERT_TYPE.RSA, function (result) {\r\n      task.result = function () {\r\n        if (result['success']) {\r\n          addSafeResult(kDetectID.RSA_CERT, 'RSA 证书链正常');\r\n        } else {\r\n          addDangerResult(kDetectID.RSA_CERT, 'RSA 证书链异常');\r\n        }\r\n      };\r\n      task.finished = true;\r\n    });\r\n  }\r\n\r\n\r\n  function detectSM2CertChain(certs) {\r\n    var task = enqueueTask('检测 SM2 证书链', false);\r\n    plugin.checkCertChain(certs, NPBank.CERT_TYPE.SM2, function (result) {\r\n      task.result = function () {\r\n        if (result['success']) {\r\n          addSafeResult(kDetectID.SM2_CERT, 'SM2 证书链正常');\r\n        } else {\r\n          addDangerResult(kDetectID.SM2_CERT, 'SM2 证书链异常');\r\n        }\r\n      };\r\n      task.finished = true;\r\n    });\r\n  }\r\n\r\n\r\n  function detectSKFDriver(name) {\r\n    var task = enqueueTask('检测U宝驱动', false);\r\n    plugin.checkSKFDriver(name, function (resultDriver) {\r\n      task.result = function () {\r\n        if (resultDriver[0]['skf_state']) {\r\n          addSafeResult(kDetectID.UKEY_DRIVER, '驱动（' + name.substr(0, listNameLength) + '）正常');\r\n        } else {\r\n          addDangerResult(kDetectID.UKEY_DRIVER, '驱动（' + name.substr(0, listNameLength) + '）未正确安装');\r\n        }\r\n      };\r\n      task.finished = true;\r\n    });\r\n  }\r\n\r\n\r\n  function detectPlugin(name) {\r\n    var result = plugin.checkPlugin(name);\r\n    var task = enqueueTask('检测 CFCA 插件', function () {\r\n      if (result) {\r\n        addSafeResult(kDetectID.PLUGIN, 'CFCA 插件（' + name.substr(0, listNameLength) + '）正常');\r\n      } else {\r\n        addDangerResult(kDetectID.PLUGIN, 'CFCA 插件（' + name.substr(0, listNameLength) + '）未正确安装');\r\n      }\r\n    });\r\n    task.finished = true;\r\n  }\r\n\r\n\r\n  /**\r\n   * 检查时间同步\r\n   * @param resp\r\n   */\r\n  function detectTime(resp) {\r\n    var task = enqueueTask('系统时间', false);\r\n    plugin.checkTime(function (sysTime) {\r\n      task.result = function () {\r\n        if (sysTime['success']) {\r\n          addSafeResult(kDetectID.TIME, '系统时间同步：' + sysTime['local_time_str']);\r\n        } else {\r\n          addWarningResult(kDetectID.TIME, '系统时间不同步');\r\n        }\r\n      };\r\n      task.finished = true;\r\n    });\r\n  }\r\n\r\n\r\n  /**\r\n   * 检查银行链接\r\n   *\r\n   * @param host\r\n   * @param path\r\n   * @param port\r\n   */\r\n  function detectBankWebsite(host, path, port) {\r\n    var task = enqueueTask('网银链接', false);\r\n    plugin.checkBankWebsite(host, path, port, function (result) {\r\n      task.result = function () {\r\n        if (result['success']) {\r\n          addSafeResult(kDetectID.WEBSITE, '网银链接正常');\r\n        } else {\r\n          addWarningResult(kDetectID.WEBSITE, '网银链接不可用');\r\n        }\r\n      };\r\n      task.finished = true;\r\n    });\r\n  }\r\n\r\n\r\n  //-----------------------------------------------------------\r\n  //-- 修复\r\n  //-----------------------------------------------------------\r\n\r\n  function fixCACertSM2(certs, element) {\r\n    certs = $.isArray(certs) ? certs : [certs];\r\n\r\n    var certFiles = [];\r\n    for (var i = 0; i < certs.length; i++) {\r\n      certFiles.push(getResourcePath('cert/' + certs[i]));\r\n    }\r\n\r\n    console.log('[fixCACertSM2]', certFiles);\r\n    plugin.installCACert(certFiles, NPBank.CERT_TYPE.SM2, function (resultCert) {\r\n      console.log('[fixCACertSM2 callback]', resultCert);\r\n      if (resultCert['success']) {\r\n        updateWarningAndDangerUI(true, element);\r\n        checkAllFixingFinished(true);\r\n      }\r\n      else {\r\n        updateWarningAndDangerUI(false, element, resultCert['msg']);\r\n        checkAllFixingFinished(false);\r\n      }\r\n\r\n    });\r\n\r\n\r\n    // var fixedCount = 0;\r\n    // var fixedFinished = 0;\r\n    // var msg = '';\r\n    //\r\n    // for (var i = 0; i < certs.length; i++) {\r\n    //   console.log('[fixCACertSM2]', getResourcePath('cert/' + certs[i]));\r\n    //   plugin.installCACert(getResourcePath('cert/' + certs[i]), NPBank.CERT_TYPE.SM2, function (resultCert) {\r\n    //     fixedFinished++;\r\n    //\r\n    //     if (resultCert['success']) {\r\n    //       fixedCount++;\r\n    //     }\r\n    //     else {\r\n    //       msg += resultCert['msg'] + '<br>';\r\n    //     }\r\n    //\r\n    //     // 安装完全部证书才显示修改成功\r\n    //     if (fixedFinished == certs.length) {\r\n    //       var allFixed = (fixedFinished==fixedCount);\r\n    //       checkAllFixingFinished(allFixed);\r\n    //       updateWarningAndDangerUI(allFixed, element, msg);\r\n    //     }\r\n    //   });\r\n    // }\r\n  }\r\n\r\n\r\n  function fixCACertRSA(certs, element) {\r\n    certs = $.isArray(certs) ? certs : [certs];\r\n\r\n    var certFiles = [];\r\n    for (var i = 0; i < certs.length; i++) {\r\n      certFiles.push(getResourcePath('cert/' + certs[i]));\r\n    }\r\n\r\n    console.log('[fixCACertRSA]', certFiles);\r\n\r\n    plugin.installCACert(certFiles, NPBank.CERT_TYPE.RSA, function (resultCert) {\r\n      console.log('[fixCACertRSA callback]', resultCert);\r\n      if (resultCert['success']) {\r\n        updateWarningAndDangerUI(true, element);\r\n        checkAllFixingFinished(true);\r\n      }\r\n      else {\r\n        updateWarningAndDangerUI(false, element, resultCert['msg']);\r\n        checkAllFixingFinished(false);\r\n      }\r\n    });\r\n\r\n    // var fixedCount = 0;\r\n    // var fixedFinished = 0;\r\n    // var msg = '';\r\n    //\r\n    // for (var i = 0; i < certs.length; i++) {\r\n    //   console.log('[fixCACertRSA]', getResourcePath('cert/' + certs[i]));\r\n    //   plugin.installCACert(getResourcePath('cert/' + certs[i]), NPBank.CERT_TYPE.RSA, function (resultCert) {\r\n    //     fixedFinished++;\r\n    //\r\n    //     if (resultCert['success']) {\r\n    //       fixedCount++;\r\n    //     }\r\n    //     else {\r\n    //       msg += resultCert['msg'] + '<br>';\r\n    //     }\r\n    //\r\n    //     // 安装完全部证书才显示修改成功\r\n    //     if (fixedFinished == certs.length) {\r\n    //       var allFixed = (fixedFinished==fixedCount);\r\n    //       checkAllFixingFinished(allFixed);\r\n    //       updateWarningAndDangerUI(allFixed, element, msg);\r\n    //     }\r\n    //   });\r\n    // }\r\n  }\r\n\r\n\r\n  function fixDriver(element) {\r\n    var drivers = ['CMBC.exe', 'CMBC_HB_UranuSafe_Install.exe'];\r\n    var fixedCount = 0;\r\n    var fixedFinished = 0;\r\n    var msg = '';\r\n\r\n    for (var i = 0; i < drivers.length; i++) {\r\n      console.log('[fixDriver-'+i+']', getResourcePath('bin/driver/' + drivers[i]));\r\n      plugin.installApplication(getResourcePath('bin/driver/' + drivers[i]), '/S', NPBank.PROGRAM_TYPE.DRIVER, function (result) {\r\n        fixedFinished++;\r\n\r\n        if (result['success']) {\r\n          fixedCount++;\r\n        }\r\n        else {\r\n          msg += result['msg'] + '<br>';\r\n        }\r\n\r\n        // 安装完全部证书才显示修改成功\r\n        if (fixedFinished == drivers.length) {\r\n          var allFixed = (fixedFinished==fixedCount);\r\n          checkAllFixingFinished(allFixed);\r\n          updateWarningAndDangerUI(allFixed, element, msg);\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n\r\n  function fixPlugin(element) {\r\n    console.log('[fixPlugin]', getResourcePath('bin/plugin/CryptoKit.CMBC.QIYE.exe'));\r\n    plugin.installApplication(getResourcePath('bin/plugin/CryptoKit.CMBC.QIYE.exe'), \"/S\", NPBank.PROGRAM_TYPE.DRIVER, function (resultApp) {\r\n      if (!resultApp['success']) {\r\n        updateWarningAndDangerUI(false, element, resultApp['msg']);\r\n        checkAllFixingFinished(false);\r\n      }\r\n      else {\r\n        needRestartBrowser = true;\r\n        updateWarningAndDangerUI(true, element);\r\n        checkAllFixingFinished(true);\r\n      }\r\n\r\n    });\r\n  }\r\n\r\n\r\n  function fixHostFile(domain, element) {\r\n    plugin.repairHostFile(domain, function (resultHost) {\r\n      if (resultHost['success']) {\r\n        updateWarningAndDangerUI(true, element);\r\n        checkAllFixingFinished(true);\r\n      }\r\n      else {\r\n        updateWarningAndDangerUI(false, element, resultApp['msg']);\r\n        checkAllFixingFinished(false);\r\n      }\r\n\r\n    });\r\n  }\r\n\r\n\r\n  //-----------------------------------------------------------\r\n  //-- 处理检测结果\r\n  //-----------------------------------------------------------\r\n\r\n  /**\r\n   * 检测到危险的项目\r\n   * @param id\r\n   * @param title\r\n   * @param detailCallback\r\n   * @param fixCallback\r\n   */\r\n  function addDangerResult(id, title, detailCallback, fixCallback) {\r\n    if (!isRunning) return;\r\n\r\n    // 如果是没有安装杀软，不加入待修复列表\r\n    if (id != kDetectID.ANTIVIRUS){\r\n      dangerCount.push(id);\r\n    }\r\n\r\n    var itemHtml = $('<li class=\"detect-item-' + id + ' clearfix\"><span class=\"d-info\">' + title + '</span><a class=\"btn btn-xs btn-danger pull-right\">异常</a></li>');\r\n\r\n    if (detailCallback) {\r\n      itemHtml.append('<a class=\"btn btn-xs btn-info pull-right\">详情</a>');\r\n      itemHtml.find('.btn-info').click(detailCallback);\r\n    }\r\n\r\n    if (fixCallback) {\r\n      itemHtml.append('<a class=\"btn btn-xs btn-success pull-right\">修复</a>');\r\n      itemHtml.find('.btn-success').click(fixCallback);\r\n    }\r\n\r\n    dangerCountEl.text(dangerCount.length);\r\n    itemHtml.hide().appendTo(dangerCtEl).slideDown('slow');\r\n  }\r\n\r\n\r\n  /**\r\n   * 检测到有风险的项目\r\n   * @param id\r\n   * @param title\r\n   * @param detailCallback\r\n   * @param fixCallback\r\n   */\r\n  function addWarningResult(id, title, detailCallback, fixCallback) {\r\n    if (!isRunning) return;\r\n    warningCount.push(id);\r\n    var itemHtml = $('<li class=\"detect-item-' + id + ' clearfix\"><span class=\"d-info\">' + title + '</span><a class=\"btn btn-xs btn-warning pull-right\">警告</a></li>');\r\n\r\n    if (detailCallback) {\r\n      itemHtml.append('<a class=\"btn btn-xs btn-info pull-right\">详情</a>');\r\n      itemHtml.find('.btn-info').click(detailCallback);\r\n    }\r\n    if (fixCallback) {\r\n      itemHtml.append('<a class=\"btn btn-xs btn-success pull-right\">修复</a>');\r\n      itemHtml.find('.btn-success').click(fixCallback);\r\n    }\r\n\r\n    warningCountEl.text(warningCount.length);\r\n    itemHtml.hide().appendTo(warningCtEl).slideDown('slow');\r\n  }\r\n\r\n\r\n  /**\r\n   * 检测到安全的项目\r\n   * @param id\r\n   * @param title\r\n   * @param detailCallback\r\n   */\r\n  function addSafeResult(id, title, detailCallback) {\r\n    if (!isRunning) return;\r\n    safeCount.push(id);\r\n    var itemHtml = $('<li class=\"detect-item-' + id + ' clearfix\"><span class=\"d-info\">' + title + '</span><a class=\"btn btn-xs btn-success pull-right\">正常</a></li>');\r\n    if (detailCallback) {\r\n      itemHtml.append('<a class=\"btn btn-xs btn-info pull-right\">详情</a>');\r\n      itemHtml.find('.btn-info').click(detailCallback);\r\n    }\r\n\r\n    safeCountEl.text(safeCount.length);\r\n    itemHtml.hide().appendTo(safeCtEl).slideDown('slow');\r\n  }\r\n\r\n\r\n  /**\r\n   * 处理检测的结果\r\n   */\r\n  function handleResultQueue() {\r\n\r\n    var displayedCount=0, startedIndex=0;\r\n\r\n    var handleOne = function () {\r\n\r\n      for (var i=0; i<resultQueue.length; i++){\r\n        var task = resultQueue[i];\r\n        if(!task.started){\r\n          task.started = true;\r\n          startedIndex++;\r\n          infoEl.text('正在检测第 '+startedIndex+' 项：' + task.title);\r\n          break;\r\n        }\r\n      }\r\n\r\n\r\n      for (var i=0; i<resultQueue.length; i++){\r\n        var task = resultQueue[i];\r\n        if(task.finished && !task.displayed){\r\n          // 显示结果\r\n          task.displayed = true;\r\n          displayedCount++;\r\n\r\n          sliderEl.animate({\r\n            width: Math.ceil(displayedCount / resultQueue.length * 100) + '%'\r\n          }, 500);\r\n\r\n          task['result'].call();\r\n          break;\r\n        }\r\n      }\r\n\r\n      // // 当有下一个结果时，提示下一项\r\n      // if (resultQueue.length > 1) {\r\n      //   resultQueue = resultQueue.slice(1);\r\n      //\r\n      //   infoEl.text('正在检测第 ' + (resultIndex + 1) + ' 项：' + resultQueue[0]['title']);\r\n      //   sliderEl.animate({\r\n      //     width: Math.ceil(resultIndex / total_detection * 100) + '%'\r\n      //   }, 500);\r\n      // }\r\n\r\n      // 全部检测结束\r\n      if (displayedCount == resultQueue.length) {\r\n        clearInterval(resultTimer);\r\n        showDetectionStatistics();\r\n      }\r\n    };\r\n\r\n    handleOne();\r\n\r\n    resultTimer = setInterval(handleOne, 1000);\r\n  }\r\n\r\n\r\n  /**\r\n   * 全部检测完成，统计并显示结果\r\n   */\r\n  function showDetectionStatistics() {\r\n    // 重新检测按钮\r\n    restartButton.siblings().hide();\r\n    restartButton.show();\r\n    // 如果有问题显示一键修复按钮\r\n    if (dangerCount.length > 0 || warningCount.length > 0) {\r\n      fixAllButton.show();\r\n    }\r\n    titleEl.text('全部完成');\r\n    infoEl.text('一共检测 ' + resultQueue.length + ' 项，发现 ' + dangerCount.length + ' 项异常');\r\n    sliderEl.animate({\r\n      width: '100%'\r\n    }, 500);\r\n    isRunning = false;\r\n    // app.releaseScreen();\r\n    // toastr.success('检测完成！');\r\n  }\r\n\r\n\r\n  //-----------------------------------------------------------\r\n  //-- 其它\r\n  //-----------------------------------------------------------\r\n\r\n  /**\r\n   * 将任务入队\r\n   * @param name\r\n   * @param handler\r\n   */\r\n  function enqueueTask(name, handler) {\r\n\r\n    var task = {\r\n      title: name,\r\n      started: false,\r\n      finished: false,\r\n      displayed: false,\r\n      result: handler\r\n    };\r\n    resultQueue.push(task);\r\n    return task;\r\n  }\r\n\r\n\r\n  /**\r\n   *\r\n   */\r\n  function restartAfterRepairing() {\r\n    $.confirm({\r\n      text: \"现在需要您重启客户端来完成一键修复。\",\r\n      confirm: function () {\r\n        win.reload();\r\n      },\r\n      confirmButton: \"立即重启\",\r\n      cancelButton: \"手动重启\"\r\n    });\r\n  }\r\n\r\n\r\n  function getResourcePath(file) {\r\n    return path.resolve(global.__dirname + \"/dist/\" + file);\r\n  }\r\n\r\n\r\n  function updateWarningAndDangerUI(success, element, msg) {\r\n    if (success){\r\n      element.find('.btn-danger,.btn-warning').text('已修复').removeClass('btn-danger btn-warning').addClass('btn-success');\r\n    }\r\n    else {\r\n      //var span = element.find('span.d-info');\r\n      element.append( '<p>'+msg+'</p>' );\r\n    }\r\n  }\r\n\r\n\r\n  /**\r\n   * 重置检测参数\r\n   */\r\n  function reset() {\r\n\r\n    // 重置结果队列\r\n    isRunning = false;\r\n    dangerCount = [];\r\n    warningCount = [];\r\n    safeCount = [];\r\n    fixedCount = 0;\r\n    resultQueue = [];\r\n    resultIndex = 0;\r\n    clearInterval(resultTimer);\r\n\r\n    // 重置插件对象\r\n    var id = plugin ? plugin.id : 'secure-plugin';\r\n    $('#' + id).remove();\r\n    plugin = new NPBank(id);\r\n\r\n\r\n    // 重置 UI\r\n    dangerCtEl.empty();\r\n    warningCtEl.empty();\r\n    safeCtEl.empty();\r\n    dangerCountEl.text(dangerCount.length);\r\n    warningCountEl.text(warningCount.length);\r\n    safeCountEl.text(safeCount.length);\r\n    sliderEl.css({\r\n      width: '0%'\r\n    });\r\n    titleEl.text('为您的网银环境体检');\r\n    infoEl.text('');\r\n    $('.summary').hide();\r\n    $('.detecting').show();\r\n  }\r\n\r\n\r\n  function checkAllFixingFinished(success) {\r\n\r\n    fixedFinished++;\r\n\r\n    if (success){\r\n      fixedCount++;\r\n    }\r\n\r\n    if (fixedFinished == dangerCount.length) {\r\n      app.releaseScreen();\r\n\r\n      if (fixedCount==fixedFinished){\r\n        toastr.success('已经全部修复完成！');\r\n      }\r\n      else {\r\n        toastr.warning('部分修复完成，请您检查失败项！');\r\n      }\r\n\r\n      if (needRestartBrowser) {\r\n        restartAfterRepairing();\r\n      }\r\n\r\n    }\r\n  }\r\n\r\n\r\n  /**\r\n   * 启动全部检测\r\n   * 包括同步返回结果的，异步返回结果的\r\n   */\r\n  this.doSecureDetecting = function () {\r\n    if (isRunning) return;\r\n\r\n    // app.freezeScreen('安全检测中，请稍候...');\r\n\r\n    isRunning = true;\r\n    cancelButton.siblings().hide();\r\n    cancelButton.show();\r\n    titleEl.text('正在为您的网银环境体检');\r\n\r\n\r\n    // 检测系统\r\n    detectSystemInfo();\r\n    // 系统杀毒软件\r\n    detectAntivirus();\r\n    // 防火墙\r\n    detectFirewall();\r\n    // 检查HOST文件\r\n    detectHost('ent.cmbc.com.cn');\r\n    // 检查RSA证书链\r\n    detectRSACertChain([\r\n      '4672dc25729f024e5583b580f90bdbe993b3f445',\r\n      'd1dbe98882e5dd1a8f4caa008cbe7cf2ab1bf6d9',\r\n      'cfdf99fb86221613392c075e8e3d772bb969ef8e'\r\n    ]);\r\n    // 检查SM2证书链\r\n    detectSM2CertChain([\r\n      '5c9358205a247356101b645010ece9a7ca074111',\r\n      'e27eb610bb94eb15e6aed1150affe8d7a057399d'\r\n    ]);\r\n    // 检测驱动\r\n    detectSKFDriver('hbcmbc');\r\n    // 检查插件\r\n    detectPlugin(\"CFCA CryptoKit CMBC UKeyCheck 3.0\");\r\n    detectPlugin(\"CFCA CryptoKit CMBC 3.2\");\r\n    detectPlugin(\"CFCA CryptoKit CMBC U2 3.0\");\r\n    // 检查网银站点\r\n    detectBankWebsite('ent.cmbc.com.cn', 'eweb/static/login.html', 443);\r\n\r\n\r\n    handleResultQueue();\r\n  };\r\n\r\n\r\n  /**\r\n   * 一键修复检测到的错误\r\n   */\r\n  this.fixDetectedVulnerabilities = function () {\r\n    // 只修复危险项\r\n    // var waitingFixList = dangerCount.concat(warningCount);\r\n    var waitingFixList = dangerCount;\r\n    fixedCount = 0;\r\n    fixedFinished = 0;\r\n\r\n    app.freezeScreen('修复中，请稍候...');\r\n\r\n    for (var i = 0, len = waitingFixList.length; i < len; i++) {\r\n      var liEl = $('.detect-item-' + waitingFixList[i]);\r\n\r\n      liEl.find('p').remove();\r\n\r\n      // 如果没有危险或警告的项目标签，表示已经被修复。\r\n      // 类型相同的项目一起修改，比如修改CA证书会一次安装所有缺少的证书。\r\n      if (liEl.find('.btn-danger,.btn-warning').length == 0) {\r\n        continue;\r\n      }\r\n\r\n      switch (waitingFixList[i]) {\r\n        case kDetectID.SM2_CERT:\r\n          fixCACertSM2([\r\n            'CFCA_SM2_1.cer',\r\n            'CFCA_SM2_2.cer',\r\n            'CFCA_SM2_NORMAL_0.cer',\r\n            'CFCA_SM2_NORMAL_1.cer',\r\n            'CFCA_SM2_NORMAL_2.cer'\r\n          ], liEl);\r\n          break;\r\n        case kDetectID.RSA_CERT:\r\n          fixCACertRSA([\r\n            'cfca_test_ca.cer',\r\n            'cfca_test_gt_rca.cer',\r\n            'CFCA_RSA_1.cer',\r\n            'CFCA_RSA_2.cer',\r\n            'CFCA_RSA_NORMAL_1.cer',\r\n            'CFCA_RSA_NORMAL_2.cer'\r\n          ], liEl);\r\n          break;\r\n        case kDetectID.UKEY_DRIVER:\r\n          fixDriver(liEl);\r\n          break;\r\n        case kDetectID.PLUGIN:\r\n          fixPlugin(liEl);\r\n          break;\r\n        case kDetectID.HOST:\r\n          fixHostFile(\"win-trust.cn\", liEl);\r\n          break;\r\n        case kDetectID.ANTIVIRUS:\r\n          liEl.find('.btn-danger,.btn-warning').text('请安装杀毒软件');\r\n          break;\r\n        default:\r\n          break;\r\n      }\r\n    }\r\n  };\r\n\r\n\r\n  this.update = function (e) {\r\n  };\r\n\r\n\r\n  this.init = function () {\r\n    app.register(this);\r\n\r\n\r\n    $('#cancel-btn').click(function () {\r\n      reset();\r\n      restartButton.siblings().hide();\r\n      restartButton.show();\r\n    });\r\n\r\n    $('#fix-all-btn').click(function () {\r\n      me.fixDetectedVulnerabilities();\r\n    });\r\n\r\n    $('#start-btn,#restart-btn').click(function () {\r\n      reset();\r\n      me.doSecureDetecting();\r\n    });\r\n  }\r\n};","/**\r\n * Created by Jonathan on 2016-12-11.\r\n */\r\n\r\nvar homePage = new function () {\r\n\r\n  function switchLoginPage(keyType){\r\n    if ($('#page-home iframe').length>0){\r\n      var currentSrc = $('#page-home iframe').prop('src');\r\n\r\n      // 只在登录页面做切换处理\r\n      if (currentSrc != app.CSP_LOGIN_URL && currentSrc != app.SKF_LOGIN_URL && currentSrc != app.NO_KEY_URL && currentSrc != app.LOGIN_URL) {\r\n        return;\r\n      }\r\n\r\n      $('#page-home').html();\r\n    }\r\n\r\n    var src = keyType ? ( keyType=='SFK'? app.SKF_LOGIN_URL : app.CSP_LOGIN_URL ) : app.LOGIN_URL;\r\n\r\n    $('#page-home').html('<iframe id=\"browser\" name=\"'+ Date.now() +'\" src=\"'+src+'\" nwfaketop nwdisable></iframe>');\r\n  }\r\n\r\n\r\n  this.init = function () {\r\n    app.register(this);\r\n  };\r\n\r\n\r\n  this.update = function (e) {\r\n    if (e.name == 'keyInject'){\r\n      //switchLoginPage(true);\r\n    }\r\n    else if (e.name == 'keyEject'){\r\n      switchLoginPage(false);\r\n    }\r\n    else if (e.name == 'deviceCertUpdate'){\r\n      console.log('homePage.deviceCertUpdate', e);\r\n      if( !$.isArray(e.data) || e.data.length==0){\r\n        switchLoginPage(false);\r\n      }\r\n      else {\r\n        var hasSkf = false;\r\n\r\n        for (var i=0; i<e.data.length; i++){\r\n          if (e.data[i]['devFrom'].toLowerCase() == 'skf'){\r\n            hasSkf = true;\r\n            break;\r\n          }\r\n        }\r\n\r\n        switchLoginPage(hasSkf?'SKF':'CSP');\r\n      }\r\n    }\r\n  };\r\n  \r\n};\r\n","/**\r\n * Created by Jonathan on 2016-12-11.\r\n */\r\n\r\nvar certPage = new function () {\r\n\r\n\r\n  function resetShowCertDetail() {\r\n    $('#cert-issuer').text('');\r\n    $('#cert-serialNumber').text('');\r\n    $('#cert-validDate').text('');\r\n    $('#cert-verify').text(\"\");\r\n  }\r\n\r\n\r\n  function refreshDevice() {\r\n    app.keyPlugin.readDeviceAndCert(function (deviceCertData) {\r\n      app.notify('deviceCertUpdate', deviceCertData);\r\n    })\r\n  }\r\n\r\n\r\n  function onDeviceUpdate(deviceCertData) {\r\n    console.log(\"certPage.onDeviceUpdate\", arguments);\r\n    var ukeySelector = $('.ukey-selector'), certSelector = $('.cert-selector');\r\n\r\n    ukeySelector.empty();\r\n    certSelector.empty();\r\n    resetShowCertDetail();\r\n\r\n    for (var i = 0, deviceCount = deviceCertData.length; i < deviceCount; i++) {\r\n      ukeySelector.append('<option ' + (i == 0 ? 'selected' : '') + ' value=\"' + deviceCertData[i]['devNickName'] + '\">' + deviceCertData[i]['devNickName'] + '</option>')\r\n      if (i == 0) {\r\n        var certs = deviceCertData[i]['certs'];\r\n\r\n        for (var j = 0, certCount = certs.length; j < certCount; j++) {\r\n          certSelector.append('<option ' + (i == 0 ? 'selected' : '') + ' value=\"' + certs[j]['serialNumber'] + '\">' + certs[j]['commonName'] + '</option>')\r\n        }\r\n      }\r\n    }\r\n    if (deviceCertData[0] && deviceCertData[0]['certs']){\r\n      certSelector.val(deviceCertData[0]['certs'][0]['serialNumber']).change();\r\n    }\r\n  }\r\n\r\n\r\n  function showCertDetail(e) {\r\n    e.preventDefault();\r\n    var val = $( \".cert-selector option:selected\" ).val();\r\n    console.log('ShowCertButton Clicked: ', val);\r\n    app.keyPlugin.getCert('serialNumber', val, function (cert) {\r\n      app.keyPlugin.showCert(cert);\r\n    });\r\n  }\r\n\r\n\r\n  function showCertSummary(e) {\r\n    e.preventDefault();\r\n    var val = $( \".cert-selector option:selected\" ).val();\r\n    app.keyPlugin.getCert('serialNumber', val, function(cert){\r\n      if (!cert){\r\n        return;\r\n      }\r\n\r\n      $('#cert-issuer').text(cert['issuer']);\r\n      $('#cert-serialNumber').text(cert['serialNumber']);\r\n      $('#cert-validDate').text('从 ' +cert['notBefore']+' 至 '+ cert['notAfter']);\r\n\r\n\r\n      if(0==cert['verify'])\r\n      {\r\n        $('#cert-verify').text(\"通过\").css('color', '#b4ddff');\r\n      }\r\n\r\n      if(1 == cert['verify'])\r\n      {\r\n        $('#cert-verify').text(\"证书不在有效期\").css('color', \"#d9534f\");\r\n      }\r\n\r\n      if(2 == cert['verify'])\r\n      {\r\n        $('#cert-verify').text(\"证书链异常\").css('color', \"#d9534f\");\r\n      }\r\n\r\n      if(3 == cert['verify'])\r\n      {\r\n        $('#cert-verify').text(\"非法用户证书\").css('color', \"#d9534f\");\r\n      }\r\n    });\r\n\r\n  }\r\n\r\n\r\n  this.update = function (e) {\r\n    if (e.name == 'deviceCertUpdate'){\r\n      onDeviceUpdate(e.data);\r\n    }\r\n    else if (e.name == 'keyEject'){\r\n      onDeviceUpdate([]);\r\n    }\r\n  };\r\n\r\n\r\n  this.init = function () {\r\n    app.register(this);\r\n\r\n    $('#show-cert-btn').click(showCertDetail);\r\n\r\n    // 选择一个证书后，显示证书 Summary\r\n    $('.cert-selector').change(showCertSummary);\r\n\r\n\r\n    $('#reload-device').click(refreshDevice);\r\n\r\n  };\r\n\r\n};\r\n","/**\r\n * Created by Jonathan on 2016-12-11.\r\n */\r\n\r\nvar devicePage = new function () {\r\n\r\n  function changePassword(){\r\n    var oldPasswd = $('#oldPasswd').val(),\r\n        passwd = $('#passwd').val(),\r\n        confirmPasswd = $('#confirmPasswd').val(),\r\n        device = $('#page-device .ukey-selector').val(),\r\n        hintEl = $('#page-device .form-hint');\r\n\r\n    if (!device){\r\n      hintEl.text('请选择一个设备！').addClass('btn btn-danger btn-xs');\r\n      return;\r\n    }\r\n    if (!oldPasswd || !passwd || !confirmPasswd ){\r\n      hintEl.text('原始密码和新密码都不能为空！').addClass('btn btn-danger btn-xs');\r\n      return;\r\n    }\r\n    if (passwd != confirmPasswd ){\r\n      hintEl.text('两次密码不一致！').addClass('btn btn-danger btn-xs');\r\n      return;\r\n    }\r\n    if (oldPasswd.length<6 || oldPasswd.length>15\r\n        || passwd.length<6 || passwd.length>15\r\n        || confirmPasswd.length<6 || confirmPasswd.length>15){\r\n      hintEl.text('6-15位数字或字母！');\r\n      return;\r\n    }\r\n\r\n    console.info(device, oldPasswd, passwd)\r\n    // app.keyPlugin.changeDevicePassword(device, oldPasswd, passwd, function(resp){\r\n    //   if (!resp.success){\r\n    //     hintEl.text(resp.msg).addClass('btn btn-danger btn-xs');\r\n    //   }\r\n    // });\r\n  }\r\n  \r\n  \r\n  function refreshDevice() {\r\n    app.keyPlugin.readDeviceAndCert(function (deviceCertData) {\r\n      app.notify('deviceCertUpdate', deviceCertData);\r\n    })\r\n  }\r\n\r\n  function onDeviceUpdate(deviceCertData) {\r\n    console.log(\"devicePage.onDeviceUpdate\", arguments);\r\n    var ukeySelector = $('.ukey-selector');\r\n    ukeySelector.empty();\r\n    for (var i = 0, deviceCount = deviceCertData.length; i < deviceCount; i++) {\r\n      ukeySelector.append('<option ' + (i == 0 ? 'selected' : '') + ' value=\"' + deviceCertData[i]['devNickName'] + '\">' + deviceCertData[i]['devNickName'] + '</option>')\r\n    }\r\n  }\r\n\r\n\r\n  this.update = function (e) {\r\n    if (e.name == 'deviceCertUpdate'){\r\n      onDeviceUpdate(e.data);\r\n    }\r\n    else if (e.name == 'keyEject'){\r\n      onDeviceUpdate([]);\r\n    }\r\n  };\r\n\r\n\r\n  this.init = function () {\r\n    app.register(this);\r\n\r\n    $('#change-password').click(changePassword);\r\n\r\n    $('#refresh-device').click(refreshDevice);\r\n  };\r\n  \r\n};\r\n","var downloadPage = new function () {\r\n  var timers = [];\r\n\r\n\r\n  function initList() {\r\n    // we need this 'empty' search to force refresh the downloads list\r\n    // e.g.: find files that were removed\r\n    chrome.downloads.search({limit: 0}, function () {\r\n      chrome.downloads.search(\r\n          {limit: 6, orderBy: ['-startTime']},\r\n          show_downloads_list\r\n      );\r\n    });\r\n  }\r\n\r\n  function show_downloads_list(results) {\r\n    var targetDownloading = document.getElementById('downloading');\r\n    var targetDownloaded = document.getElementById('downloaded');\r\n    var htmlDownloading = \"\";\r\n    var htmlDownloaded = \"\";\r\n\r\n    results.forEach(function (e) {\r\n      if (e.exists) {\r\n        if (e.state == \"in_progress\") {\r\n          htmlDownloading += downloadingHtml(e);\r\n          if (!e.paused){\r\n            startTimer(e.id);\r\n          }\r\n        } else {\r\n          htmlDownloaded += downloadedHtml(e);\r\n        }\r\n      }\r\n    });\r\n\r\n    if (htmlDownloading == '') {\r\n      htmlDownloading = emptyHtml();\r\n    }\r\n    targetDownloading.innerHTML = htmlDownloading;\r\n\r\n    if (htmlDownloaded == '') {\r\n      htmlDownloaded = emptyHtml();\r\n    }\r\n    targetDownloaded.innerHTML = htmlDownloaded;\r\n  }\r\n\r\n  function startTimer(id) {\r\n    clearInterval(timers[id]);\r\n    function timer() {\r\n      var el = $(\"#download-\" + id);\r\n      var progress = $(\"#progress-bar-\" + id);\r\n      var progressText = $(\"#process-bar-text-\" + id);\r\n      chrome.downloads.search({id: id}, function (results) {\r\n        var e = results[0];\r\n        // download not found (probably deleted or canceled on danger)\r\n        if (!e) {\r\n          clearInterval(timers[id]);\r\n          initList();\r\n          return;\r\n        }\r\n\r\n        // show progress metrics (speed, size, progress bar)\r\n        if (e.state != 'complete') {\r\n          // var remaining_seconds = (new Date(e.estimatedEndTime) - new Date()) / 1000;\r\n          // var remaining_bytes = e.totalBytes - e.bytesReceived;\r\n          // var speed = remaining_bytes / remaining_seconds;\r\n          var receivePer = (100 * e.bytesReceived / e.totalBytes).toFixed(1) + \"%\";\r\n          progress.animate({width: receivePer}, 1);\r\n          progressText.text(receivePer);\r\n        } else {\r\n          // status.innerHTML = \"\";\r\n          progress.css('width', \"100%\");\r\n          progressText.text(\"100%\");\r\n          //正在下载删除当前item\r\n          removeItem(id);\r\n          //下载完成添加item\r\n          initList();\r\n          clearInterval(timers[id]);\r\n        }\r\n      });\r\n    }\r\n\r\n    timers[id] = setInterval(timer, 1000);\r\n    setTimeout(timer, 1);\r\n  }\r\n\r\n  function stopTimer(id) {\r\n    clearInterval(timers[id]);\r\n  }\r\n\r\n  function downloadingHtml(e) {\r\n    var imgSrc = './dist/img/file-large.png';\r\n    var stateImg ;\r\n    var stateText ;\r\n    var state;\r\n    var receivePer = (100 * e.bytesReceived / e.totalBytes).toFixed(1) + \"%\";\r\n    if(e.paused){\r\n      stateImg = './dist/img/continue.png';\r\n      stateText = '继续';\r\n      state = 'resume';\r\n    } else {\r\n      stateImg = './dist/img/pause.png';\r\n      stateText = '暂停';\r\n      state = 'pause';\r\n    }\r\n\r\n    chrome.downloads.getFileIcon(e.id, {}, function (icon) {\r\n      if (icon) {\r\n        imgSrc = icon;\r\n      }\r\n    });\r\n\r\n    return '<li id=\"' + e.id + '\">' +\r\n        '<div class=\"left\">' +\r\n        '<img src=\"' + imgSrc + '\">' +\r\n        '<div class=\"item-title\">' + e.filename.replace(/^.*[\\\\\\/]/, '') + '</div>' +\r\n        '<div class=\"progress\">' +\r\n        '<div id=\"progress-bar-' + e.id + '\" class=\"progress-bar progress-bar-success\" role=\"progressbar\" aria-valuenow=\"40\" aria-valuemin=\"0\" aria-valuemax=\"100\" style=\"width:'+receivePer+'\">' +\r\n        '<span id=\"process-bar-text-' + e.id + '\">'+receivePer+'</span>' +\r\n        '</div>' +\r\n        '</div>' +\r\n        '</div>' +\r\n        '<div class=\"right\">' +\r\n        '<div class=\"cancel-dw\" downloading-id=\"' + e.id + '\"><img src=\"/dist/img/ex-cancel.png\"><span>取消</span></div>' +\r\n        '<div class=\"downloading-control\" downloading-id=\"' + e.id + '\" btn-state=\"'+state+'\"><img src=\"'+stateImg+'\"><span>'+stateText+'</span></div>' +\r\n        '</div>' +\r\n        '</li>'\r\n  }\r\n\r\n\r\n  function downloadedHtml(e) {\r\n    var imgSrc = './dist/img/file-large.png';\r\n    chrome.downloads.getFileIcon(e.id, {}, function (icon) {\r\n      if (icon) {\r\n        imgSrc = icon;\r\n      }\r\n    });\r\n\r\n    var completeTime = new Date(e.endTime);\r\n    return '<li id=\"' + e.id + '\">' +\r\n        '<div class=\"left\">' +\r\n        '<img src=\"' + imgSrc + '\">' +\r\n        '<div class=\"item-title\">' + e.filename.replace(/^.*[\\\\\\/]/, '') + '</div>' +\r\n        '<div>' +\r\n        '<span class=\"\">' + sizeFormat(e.fileSize) + '</span>' +\r\n        '<span class=\"date\">' + completeTime.toLocaleTimeString() + '</span>' +\r\n        '</div>' +\r\n        '</div>' +\r\n        '<div class=\"right\">' +\r\n        '<div class=\"delete-file\" download-id=\"' + e.id + '\"><img src=\"/dist/img/ex-delete.png\"><span>删除</span></div>' +\r\n        '<div class=\"execute-file\" download-id=\"' + e.id + '\"><img src=\"/dist/img/file.png\"><span>打开</span></div>' +\r\n        '<div class=\"open-dir\"><img src=\"/dist/img/dir.png\"><span>文件夹</span></div>' +\r\n        '</div>' +\r\n        '</li>'\r\n  }\r\n\r\n  function sizeFormat(fileSize) {\r\n    if (!fileSize) return '0 B';\r\n    if (fileSize > 1024 * 1024 * 1024 * 1024) return (fileSize / 1024 / 1024 / 1024).toFixed(2) + \" GB\";\r\n    if (fileSize < 1024 * 1024 * 1024) return (fileSize / 1024 / 1024).toFixed(2) + \" MB\";\r\n    if (fileSize < 1024 * 1024) return (fileSize / 1024).toFixed(2) + \" KB\";\r\n    return fileSize + \" B\";\r\n  }\r\n\r\n  function time_format(s) {\r\n    if (s < 60) return Math.ceil(s) + \" secs\";\r\n    if (s < 60 * 5) return Math.floor(s / 60) + \" mins \" + Math.ceil(s % 60) + \" secs\";\r\n    if (s < 60 * 60) return Math.ceil(s / 60) + \" mins\";\r\n    if (s < 60 * 60 * 5) return Math.floor(s / 60 / 60) + \" hours \" + (Math.ceil(s / 60) % 60) + \" mins\";\r\n    if (s < 60 * 60 * 24) return Math.ceil(s / 60 / 60) + \" hours\";\r\n    return Math.ceil(s / 60 / 60 / 24) + \" days\";\r\n  }\r\n\r\n  function emptyHtml() {\r\n    return '<li><div>没有下载内容</div></li>';\r\n  }\r\n\r\n  function removeItem(id) {\r\n    var node = document.getElementById(id);\r\n    node.parentNode.removeChild(node);\r\n  }\r\n\r\n  function clearAllDownloads() {\r\n    chrome.downloads.search({}, function (results) {\r\n      results.forEach(function (item) {\r\n        chrome.downloads.erase({id: item.id});\r\n      });\r\n    });\r\n    initList();\r\n  }\r\n\r\n\r\n  function changeState(state, id) {\r\n    var itemId = parseInt(id);\r\n    chrome.downloads[state](itemId);\r\n    if (/resume/.test(state))\r\n      startTimer(itemId);\r\n    else if (/cancel|pause/.test(state))\r\n      stopTimer(itemId);\r\n  }\r\n\r\n  this.init = function () {\r\n    chrome.downloads.onCreated.addListener(function () {\r\n      initList();\r\n    });\r\n\r\n    chrome.downloads.onChanged.addListener(function (delta) {\r\n      initList();\r\n    });\r\n\r\n\r\n    //下载管理\r\n    $('#nav-download').click(function () {\r\n      initList();\r\n    });\r\n\r\n    $('#downloading').on('click', '.downloading-control', function (e) {\r\n      var id;\r\n      var state;\r\n\r\n      if ($(e.target).attr('downloading-id')) {\r\n        id = $(e.target).attr('downloading-id');\r\n        state = $(e.target).attr('btn-state');\r\n      } else {\r\n        id = $(e.target).parent().attr('downloading-id');\r\n        state = $(e.target).parent().attr('btn-state');\r\n      }\r\n\r\n      if (/resume|cancel|pause/.test(state)) {\r\n        changeState(state, id);\r\n\r\n        if (/resume/.test(state)){\r\n          $('.downloading-control:first-child').attr('src','./dist/img/in.png');\r\n          $('.downloading-control:last-child').text('暂停');\r\n        } else {\r\n          $('.downloading-control:first-child').attr('src','./dist/img/continue.png');\r\n          $('.downloading-control:last-child').text('继续');\r\n        }\r\n      }\r\n    });\r\n\r\n    $('#downloading').on('click', '.cancel-dw', function (e) {\r\n      var id;\r\n      if ($(e.target).attr('downloading-id')) {\r\n        id = $(e.target).attr('downloading-id');\r\n      } else {\r\n        id = $(e.target).parent().attr('downloading-id');\r\n      }\r\n\r\n      stopTimer(id);\r\n      chrome.downloads.erase({id: parseInt(id)});\r\n      removeItem(id);\r\n    });\r\n\r\n    $('#downloaded').on('click', '.execute-file', function (e) {\r\n      var downloadId = '';\r\n      console.log(e);\r\n      if ($(e.target).attr('download-id')) {\r\n        downloadId = $(e.target).attr('download-id');\r\n      } else {\r\n        downloadId = $(e.target).parent().attr('download-id');\r\n      }\r\n      chrome.downloads.open(parseInt(downloadId));\r\n    });\r\n\r\n    $('#downloaded').on('click', '.open-dir', function (e) {\r\n      chrome.downloads.showDefaultFolder();\r\n    });\r\n\r\n    $('#downloaded').on('click', '.delete-file', function (e) {\r\n      var downloadId = '';\r\n      if ($(e.target).attr('download-id')) {\r\n        downloadId = $(e.target).attr('download-id');\r\n      } else {\r\n        downloadId = $(e.target).parent().attr('download-id');\r\n      }\r\n      chrome.downloads.removeFile(parseInt(downloadId));\r\n      removeItem(downloadId);\r\n    });\r\n\r\n    $('#clearAll').click(function () {\r\n      clearAll();\r\n    });\r\n  }\r\n};\r\n\r\n\r\n\r\n\r\n","/**\r\n * Created by Jonathan on 2016-12-9.\r\n */\r\n\r\nvar nw = require('nw.gui');\r\nvar win = nw.Window.get();\r\n// win.setMaximumSize(screen.availWidth+15, screen.availHeight+15);\r\nwin.maximize();\r\nwin.setResizable(false);\r\nwin.show();\r\n\r\n\r\n// 配置 toaster 样式\r\ntoastr.options = {\r\n  \"positionClass\": \"toast-top-center\"\r\n};\r\n\r\n\r\n$(function(){\r\n\r\n  function initWindowControlButtons() {\r\n    $('.btn-close').click(function () {\r\n      win.close();\r\n    });\r\n\r\n    $('.btn-resize').click(function () {\r\n      win.restore();\r\n    });\r\n\r\n    $('.btn-minimize').click(function () {\r\n      win.minimize();\r\n    });\r\n\r\n    $('.btn-maximize').click(function () {\r\n      win.maximize();\r\n    });\r\n\r\n    $('.btn-back').click(function (e) {\r\n      e.preventDefault();\r\n      $('#browser')[0].contentWindow.window.history.back();\r\n    });\r\n\r\n    $('.btn-forward').click(function (e) {\r\n      e.preventDefault();\r\n      $('#browser')[0].contentWindow.window.history.forward();\r\n    });\r\n  }\r\n\r\n\r\n  function initTabPages() {\r\n    $('.nav a').click(function (e) {\r\n      e.preventDefault();\r\n      $(this).tab('show');\r\n\r\n      // 只有在我的网银页面显示前进后退按钮\r\n      if ( this.hash == '#page-home'){\r\n        $('.nav-control').show();\r\n      } else {\r\n        $('.nav-control').hide();\r\n      }\r\n    });\r\n  }\r\n\r\n\r\n  function initHome(){\r\n    // $('#browser').prop('src', app.KEY_LOGIN_URL);\r\n\r\n    // 在同一iframe中打开新页面\r\n    win.on('new-win-policy', function (frame, url, policy) {\r\n      policy.ignore(); //ignore policy first to prevent popup\r\n      $(\"#browser\").prop(\"src\",url); //load popup url into iFrame\r\n    });\r\n  }\r\n\r\n\r\n  function initNetwork() {\r\n    $('#cache-checker').change(function () {\r\n      Network.setExitClear(this.checked);\r\n    });\r\n\r\n    $('#btn-clear-cache').click(function () {\r\n      Network.clearCache();\r\n    });\r\n\r\n    $('#btn-proxy-submit').click(function () {\r\n      var host = $('#host').val(),\r\n          port = $('#port').val(),\r\n          name = $('#name').val(),\r\n          password = $('#password').val();\r\n\r\n      if (!host || !port || !name || !password) {\r\n        toastr.warning('代理配置不能为空！');\r\n        return;\r\n      }\r\n      Network.setProxy(host, port, name, password);\r\n    });\r\n  }\r\n\r\n  initHome();\r\n  initWindowControlButtons();\r\n  initTabPages();\r\n\r\n  app.init();\r\n  homePage.init();\r\n  certPage.init();\r\n  devicePage.init();\r\n  securePage.init();\r\n  downloadPage.init();\r\n});"]}